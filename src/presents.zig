const std = @import("std");
const fr = @import("framework");

const Vertex = fr.Geometry.Vertex;

var program: fr.gl.Program = undefined;
var arrays: [3]fr.gl.VertexArray = undefined;

var progress_program: fr.gl.Program = undefined;
var progress_array: fr.gl.VertexArray = undefined;

var vertex_bufs: [3]fr.gl.Buffer = undefined;
var groups: [3][]fr.Geometry.Group = undefined;

const scale = 0.01;
const height = 1;
const ribbon_color = fr.Vec3{ .x = 1, .y = 0.3254902, .z = 0.2039216 };
const collect_distance = 0.01;

const object_coords = [_]fr.Vec2{
    .{ .x = 41.023415, .y = 43.001525 },
    .{ .x = 69.240073, .y = 34.575503 },
    .{ .x = 19.933333, .y = 60.1 },
    .{ .x = 19.818698, .y = 41.327546 },
    .{ .x = 3.042048, .y = 36.752887 },
    .{ .x = -170.702036, .y = -14.275632 },
    .{ .x = 1.521835, .y = 42.506317 },
    .{ .x = 13.289437, .y = -8.839988 },
    .{ .x = -63.057441, .y = 18.214813 },
    .{ .x = 0, .y = -90 },
    .{ .x = -61.846772, .y = 17.12741 },
    .{ .x = -58.381559, .y = -34.603684 },
    .{ .x = 44.499103, .y = 40.179186 },
    .{ .x = -70.008631, .y = 12.509204 },
    .{ .x = 149.128684, .y = -35.282 },
    .{ .x = 16.373819, .y = 48.208174 },
    .{ .x = 49.867092, .y = 40.409262 },
    .{ .x = -77.355413, .y = 25.047984 },
    .{ .x = 50.58605, .y = 26.228516 },
    .{ .x = 90.412518, .y = 23.810332 },
    .{ .x = -59.598809, .y = 13.113222 },
    .{ .x = 27.561524, .y = 53.90454 },
    .{ .x = 4.35171, .y = 50.85034 },
    .{ .x = -88.75902, .y = 17.251011 },
    .{ .x = 2.628852, .y = 6.496857 },
    .{ .x = -64.781375, .y = 32.294816 },
    .{ .x = 89.639286, .y = 27.472792 },
    .{ .x = -68.119294, .y = -16.489689 },
    .{ .x = 18.413076, .y = 43.856259 },
    .{ .x = 25.923147, .y = -24.628208 },
    .{ .x = 3.38, .y = -54.43 },
    .{ .x = -47.882166, .y = -15.794229 },
    .{ .x = 55.4778, .y = 21.3419 },
    .{ .x = -64.618466, .y = 18.428612 },
    .{ .x = 114.939821, .y = 4.903052 },
    .{ .x = 23.321868, .y = 42.697708 },
    .{ .x = -1.51966, .y = 12.371428 },
    .{ .x = 29.359878, .y = -3.361378 },
    .{ .x = 104.892167, .y = 11.544873 },
    .{ .x = 11.502075, .y = 3.848033 },
    .{ .x = -75.697193, .y = 45.42153 },
    .{ .x = -23.513327, .y = 14.93305 },
    .{ .x = -81.367439, .y = 19.286932 },
    .{ .x = 18.55819, .y = 4.394674 },
    .{ .x = 15.055742, .y = 12.134846 },
    .{ .x = -70.669265, .y = -33.44889 },
    .{ .x = 116.407395, .y = 39.904211 },
    .{ .x = 105.679379, .y = -10.420686 },
    .{ .x = 96.829316, .y = -12.188834 },
    .{ .x = -74.072092, .y = 4.710989 },
    .{ .x = 43.247315, .y = -11.717216 },
    .{ .x = 15.266293, .y = -4.441931 },
    .{ .x = 15.242885, .y = -4.26336 },
    .{ .x = -159.782306, .y = -21.212901 },
    .{ .x = -84.090725, .y = 9.928069 },
    .{ .x = -5.289343, .y = 6.827623 },
    .{ .x = 15.981919, .y = 45.815011 },
    .{ .x = -82.345189, .y = 23.05407 },
    .{ .x = -68.882423, .y = 12.122422 },
    .{ .x = 33.382276, .y = 35.185566 },
    .{ .x = 14.4378, .y = 50.075538 },
    .{ .x = 12.568337, .y = 55.676097 },
    .{ .x = 43.145647, .y = 11.572077 },
    .{ .x = -61.379355, .y = 15.309168 },
    .{ .x = -69.931212, .y = 18.486058 },
    .{ .x = -78.467838, .y = -0.180653 },
    .{ .x = 31.235712, .y = 30.04442 },
    .{ .x = -89.218191, .y = 13.69294 },
    .{ .x = 8.737104, .y = 3.750412 },
    .{ .x = 38.925052, .y = 15.322877 },
    .{ .x = 24.753575, .y = 59.436961 },
    .{ .x = 38.757761, .y = 8.980603 },
    .{ .x = -57.851663, .y = -51.697713 },
    .{ .x = -6.790982, .y = 62.007864 },
    .{ .x = 178.450079, .y = -18.124809 },
    .{ .x = 24.941025, .y = 60.173324 },
    .{ .x = 2.352222, .y = 48.856614 },
    .{ .x = -52.313453, .y = 4.92242 },
    .{ .x = -149.558476, .y = -17.551625 },
    .{ .x = 55.4778, .y = -21.3419 },
    .{ .x = 9.467268, .y = 0.416198 },
    .{ .x = -16.579032, .y = 13.454876 },
    .{ .x = 44.827096, .y = 41.715138 },
    .{ .x = 13.404954, .y = 52.520007 },
    .{ .x = -0.186964, .y = 5.603717 },
    .{ .x = -5.353599, .y = 36.140773 },
    .{ .x = 23.72936, .y = 37.983917 },
    .{ .x = -51.694138, .y = 64.18141 },
    .{ .x = -61.7488, .y = 12.056098 },
    .{ .x = -61.706411, .y = 16.014453 },
    .{ .x = 144.751278, .y = 13.470891 },
    .{ .x = -90.506882, .y = 14.634915 },
    .{ .x = -2.536871, .y = 49.455443 },
    .{ .x = -13.578401, .y = 9.641185 },
    .{ .x = -15.617794, .y = 11.881655 },
    .{ .x = -58.155125, .y = 6.801279 },
    .{ .x = -72.307433, .y = 18.594395 },
    .{ .x = -87.192136, .y = 14.072275 },
    .{ .x = 114.109497, .y = 22.396428 },
    .{ .x = 19.040235, .y = 47.497912 },
    .{ .x = -21.817439, .y = 64.126521 },
    .{ .x = 77.209021, .y = 28.613939 },
    .{ .x = 106.845599, .y = -6.208763 },
    .{ .x = 51.388974, .y = 35.689198 },
    .{ .x = 44.361488, .y = 33.312806 },
    .{ .x = -6.26031, .y = 53.349805 },
    .{ .x = -4.486123, .y = 54.152337 },
    .{ .x = 34.781768, .y = 32.0853 },
    .{ .x = 12.496366, .y = 41.902784 },
    .{ .x = -76.802893, .y = 18.042327 },
    .{ .x = 139.731992, .y = 35.709026 },
    .{ .x = -2.106568, .y = 49.186823 },
    .{ .x = 35.945695, .y = 31.956578 },
    .{ .x = 71.470356, .y = 51.160523 },
    .{ .x = 36.821946, .y = -1.292066 },
    .{ .x = 172.971662, .y = 1.451817 },
    .{ .x = 21.165503, .y = 42.662914 },
    .{ .x = 47.977405, .y = 29.375859 },
    .{ .x = 74.569762, .y = 42.874621 },
    .{ .x = 102.633104, .y = 17.975706 },
    .{ .x = 24.105186, .y = 56.949649 },
    .{ .x = 35.495479, .y = 33.888629 },
    .{ .x = 27.51436, .y = -29.363219 },
    .{ .x = -10.760524, .y = 6.290743 },
    .{ .x = 13.191338, .y = 32.887209 },
    .{ .x = 9.520928, .y = 47.14103 },
    .{ .x = 25.279651, .y = 54.687156 },
    .{ .x = 6.131935, .y = 49.611621 },
    .{ .x = 113.55, .y = 22.166667 },
    .{ .x = 21.427996, .y = 41.997346 },
    .{ .x = 47.507905, .y = -18.87919 },
    .{ .x = 33.774119, .y = -13.962612 },
    .{ .x = 101.686855, .y = 3.139003 },
    .{ .x = 73.509347, .y = 4.175496 },
    .{ .x = -8.002889, .y = 12.639232 },
    .{ .x = 14.514553, .y = 35.898909 },
    .{ .x = 171.185774, .y = 7.116421 },
    .{ .x = -61.05878, .y = 14.616065 },
    .{ .x = -15.958237, .y = 18.07353 },
    .{ .x = 57.502332, .y = -20.166896 },
    .{ .x = 45.227872, .y = -12.780949 },
    .{ .x = -99.133208, .y = 19.432608 },
    .{ .x = 158.161027, .y = 6.914712 },
    .{ .x = 28.86381, .y = 47.010453 },
    .{ .x = 7.420816, .y = 43.737411 },
    .{ .x = 106.905744, .y = 47.886399 },
    .{ .x = 19.259364, .y = 42.43042 },
    .{ .x = -62.215738, .y = 16.706523 },
    .{ .x = -6.849813, .y = 33.97159 },
    .{ .x = 32.605135, .y = -25.891968 },
    .{ .x = 96.07851, .y = 19.763306 },
    .{ .x = 46.763595, .y = 39.826385 },
    .{ .x = 17.065755, .y = -22.560881 },
    .{ .x = 166.921091, .y = -0.546686 },
    .{ .x = 85.323961, .y = 27.717245 },
    .{ .x = 4.895168, .y = 52.370216 },
    .{ .x = -68.9316546, .y = 12.1091242 },
    .{ .x = 166.450524, .y = -22.255823 },
    .{ .x = 174.776236, .y = -41.28646 },
    .{ .x = -86.236174, .y = 12.114993 },
    .{ .x = 2.125385, .y = 13.511596 },
    .{ .x = 7.398574, .y = 9.076479 },
    .{ .x = -169.917871, .y = -19.055371 },
    .{ .x = 167.959588, .y = -29.056394 },
    .{ .x = 125.762524, .y = 39.039219 },
    .{ .x = 33.382276, .y = 35.185566 },
    .{ .x = 145.750967, .y = 15.177801 },
    .{ .x = 10.752245, .y = 59.913869 },
    .{ .x = 58.405923, .y = 23.58589 },
    .{ .x = 73.093146, .y = 33.729388 },
    .{ .x = 134.624289, .y = 7.500384 },
    .{ .x = 35.5354719, .y = 31.9073509 },
    .{ .x = -79.402864, .y = 9.101179 },
    .{ .x = 147.180267, .y = -9.4438 },
    .{ .x = -57.575926, .y = -25.26374 },
    .{ .x = -77.042793, .y = -12.046374 },
    .{ .x = 120.98422, .y = 14.599512 },
    .{ .x = -130.100464, .y = -25.06629 },
    .{ .x = 21.012229, .y = 52.229676 },
    .{ .x = -9.139337, .y = 38.722252 },
    .{ .x = -66.105722, .y = 18.466334 },
    .{ .x = 51.53104, .y = 25.285447 },
    .{ .x = 55.450675, .y = -20.882057 },
    .{ .x = 26.102538, .y = 44.426767 },
    .{ .x = 37.6173, .y = 55.755826 },
    .{ .x = 30.112735, .y = -1.957875 },
    .{ .x = -56.180636, .y = 46.775846 },
    .{ .x = -61.224816, .y = 13.160025 },
    .{ .x = -171.751355, .y = -13.850696 },
    .{ .x = 12.447281, .y = 43.935591 },
    .{ .x = 6.733343, .y = 0.330192 },
    .{ .x = 46.902838, .y = 24.749403 },
    .{ .x = -17.366029, .y = 14.764504 },
    .{ .x = 20.448922, .y = 44.786568 },
    .{ .x = 55.451315, .y = -4.619143 },
    .{ .x = -13.231722, .y = 8.465677 },
    .{ .x = 103.850949, .y = 1.280095 },
    .{ .x = 17.107137, .y = 48.145892 },
    .{ .x = 14.505751, .y = 46.056947 },
    .{ .x = 159.9729, .y = -9.445638 },
    .{ .x = 45.318162, .y = 2.046934 },
    .{ .x = 28.229271, .y = -25.747868 },
    .{ .x = -36.493735, .y = -54.28325 },
    .{ .x = 126.977969, .y = 37.566535 },
    .{ .x = 43.964405, .y = 42.22146 },
    .{ .x = 31.57125, .y = 4.859363 },
    .{ .x = -3.70379, .y = 40.416775 },
    .{ .x = 79.902478, .y = 6.89407 },
    .{ .x = -62.852201, .y = 17.896435 },
    .{ .x = -62.717692, .y = 17.302606 },
    .{ .x = -60.987469, .y = 14.010109 },
    .{ .x = -63.082466, .y = 18.067519 },
    .{ .x = 32.559899, .y = 15.500654 },
    .{ .x = -55.203828, .y = 5.852036 },
    .{ .x = 22.055, .y = 78.062 },
    .{ .x = 31.136672, .y = -26.305448 },
    .{ .x = 18.068581, .y = 59.329323 },
    .{ .x = 7.447447, .y = 46.947974 },
    .{ .x = 36.276528, .y = 33.513807 },
    .{ .x = 121.565418, .y = 25.032969 },
    .{ .x = 68.787038, .y = 38.559772 },
    .{ .x = 35.751607, .y = -6.162959 },
    .{ .x = 100.501765, .y = 13.756331 },
    .{ .x = 125.560314, .y = -8.556856 },
    .{ .x = 1.231362, .y = 6.172497 },
    .{ .x = -171.848, .y = -9.2005 },
    .{ .x = -175.204947, .y = -21.139342 },
    .{ .x = 29.596805, .y = 46.848185 },
    .{ .x = -61.501926, .y = 10.654901 },
    .{ .x = -12.311315, .y = -37.068042 },
    .{ .x = 10.181532, .y = 36.806495 },
    .{ .x = 32.859742, .y = 39.933364 },
    .{ .x = 58.326063, .y = 37.960077 },
    .{ .x = -71.13891, .y = 21.467458 },
    .{ .x = 179.198128, .y = -8.520066 },
    .{ .x = -64.930701, .y = 18.3419 },
    .{ .x = 32.58252, .y = 0.347596 },
    .{ .x = 30.5234, .y = 50.4501 },
    .{ .x = 54.697277, .y = 24.299174 },
    .{ .x = -0.127758, .y = 51.507351 },
    .{ .x = -77.036871, .y = 38.907192 },
    .{ .x = -56.164531, .y = -34.901113 },
    .{ .x = 69.240073, .y = 41.299496 },
    .{ .x = 168.327325, .y = -17.733251 },
    .{ .x = 12.453601, .y = 41.902179 },
    .{ .x = -66.903606, .y = 10.480594 },
    .{ .x = 105.83416, .y = 21.027764 },
    .{ .x = -176.176447, .y = -13.282509 },
    .{ .x = -13.1625, .y = 27.125287 },
    .{ .x = 44.191007, .y = 15.369445 },
    .{ .x = 28.322817, .y = -15.387526 },
    .{ .x = 31.03351, .y = -17.825166 },
};
const object_count = object_coords.len;
var collected_count: usize = 0;
var collected_objects = [1]bool{false} ** object_count;

pub fn init() !void {
    program = try fr.gl.Program.create(&.{
        .{ .t = .vertex_shader, .src = @embedFile("present.vert") },
        .{ .t = .fragment_shader, .src = @embedFile("present.frag") },
    });

    for ([3]u8{ 0, 1, 2 }) |i| {
        arrays[i] = fr.gl.VertexArray.create();

        var geometry = try fr.Geometry.loadFromFile(switch (i) {
            0 => "assets/present.obj",
            1 => "assets/present_low.obj",
            else => "assets/present_round.obj",
        });
        defer geometry.destroy();

        groups[i] = try std.heap.c_allocator.dupe(fr.Geometry.Group, geometry.groups);

        vertex_bufs[i] = fr.gl.Buffer.create();
        vertex_bufs[i].storage(Vertex, geometry.vertices);
        arrays[i].addVertexBuffer(Vertex, vertex_bufs[i]);
    }

    progress_program = try fr.gl.Program.create(&.{
        .{ .t = .vertex_shader, .src = @embedFile("present_progress.vert") },
        .{ .t = .fragment_shader, .src = @embedFile("present_progress.frag") },
    });

    progress_array = fr.gl.VertexArray.create();
}

pub fn deinit() void {
    for ([3]u8{ 0, 1, 2 }) |i| {
        vertex_bufs[i].destroy();
        std.heap.c_allocator.free(groups[i]);
        arrays[i].destroy();
    }
    program.destroy();
}

fn position(coords: fr.Vec2) fr.Vec3 {
    return fr.Vec3.fromAngles(.{ .x = (coords.x / 180.0 + 1) * std.math.pi, .y = coords.y / 180.0 * std.math.pi }).multiply(height);
}

pub fn update(plane_rotation: fr.Mat3) void {
    for (object_coords) |coords, i| {
        if (!collected_objects[i]) {
            const plane_position = plane_rotation.multiplyVec3(.{ .z = 1 });
            const distance = plane_position.negate().add(position(coords)).size();
            if (distance < collect_distance) {
                collected_objects[i] = true;
                collected_count += 1;
            }
        }
    }
}

pub fn draw(cam: fr.Camera, sun_direction: fr.Vec3, headlight_pos: fr.Vec3, headlight_dir: fr.Vec3, headlight_cutoff: f32) void {
    program.setUniform(0, cam.mat());
    program.setUniform(1, cam.position);
    program.setUniform(3, sun_direction);
    program.setUniform(5, headlight_pos);
    program.setUniform(6, headlight_dir);
    program.setUniform(7, headlight_cutoff);

    var model_mat = fr.Mat4.scalingXYZ(scale);

    for (object_coords) |coords, i| {
        if (!collected_objects[i]) {
            const pos = position(coords);
            const ay = pos.normalize();
            const az = (fr.Vec3{ .y = 1 }).cross(ay).normalize();
            const ax = ay.cross(az).normalize();
            program.setUniform(2, fr.Mat4.translation(pos).multiply(fr.Mat3.fromVectors(ax, ay, az).toMat4().multiply(model_mat)));

            for (groups[i % 3]) |group, group_i| {
                program.setUniform(4, switch (group_i) {
                    0, 2 => fr.Vec3{ .x = 1, .y = 1, .z = 1 },
                    else => ribbon_color,
                });
                fr.gl.draw(.triangles, program, arrays[i % 3], group.first, group.len);
            }
        }
    }

    progress_program.setUniform(0, @intToFloat(f32, collected_count) / @intToFloat(f32, object_count));
    progress_program.setUniform(1, ribbon_color);
    fr.gl.draw(.triangles, progress_program, progress_array, 0, 6);
}
